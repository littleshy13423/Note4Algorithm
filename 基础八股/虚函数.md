# 虚函数

虚函数的实现机制是C++语言支持运行时多态（动态多态）的基础。虚函数的实现依赖于虚函数表（Virtual Table, vtable）和虚指针（Virtual Pointer, vptr）。在C++中，当一个类中包含虚函数时，编译器会在幕后生成一个虚函数表，用于动态绑定函数调用。

## 虚函数表（Virtual Table, vtable）

虚函数表是一个存储类的虚函数地址的数组或列表。每个包含虚函数的类都有一个虚函数表。虚函数表的主要作用是在运行时根据实际对象的类型选择合适的函数进行调用。

### 虚函数表的结构

虚函数表是一个指针数组，每个元素都是该类的一个虚函数的地址。如果一个类有多个虚函数，这些虚函数的地址会按照声明的顺序保存在虚函数表中。

### 虚函数表的生成

当编译器遇到一个包含虚函数的类时，它会为这个类生成一个虚函数表，并在表中存储所有虚函数的地址。

## 虚指针（Virtual Pointer, vptr）

虚指针是一个隐藏的指针，编译器在每个包含虚函数的类的对象中添加一个虚指针。这个指针指向该类的虚函数表。

### 虚指针的初始化

当创建一个对象时，构造函数会初始化对象的虚指针，使其指向该对象所属类的虚函数表。

### 虚指针的更新

在继承层次结构中，如果派生类重写了基类的虚函数，派生类的虚函数表会覆盖基类相应位置的函数地址。当派生类对象被创建时，其虚指针会指向派生类的虚函数表。

## 虚函数调用的过程

当通过基类指针或引用调用虚函数时，编译器会生成代码来完成以下几步：

1.获取对象的虚指针：通过基类指针或引用来访问对象的虚指针（vptr）。
2.查找虚函数表：通过虚指针找到对应的虚函数表（vtable）。
3.查找虚函数地址：在虚函数表中查找要调用的虚函数的地址。
4.调用虚函数：通过查找到的函数地址进行调用。
